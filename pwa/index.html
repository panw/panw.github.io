<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Sample illustrating the use of Video / Media Session.">

  <title>Pan Video</title>
  <script src="dpad.js"></script>
  <script>
    // Add a global error event listener early on in the page load, to help ensure that browsers
    // which don't support specific functionality still end up displaying a meaningful message.
    window.addEventListener('error', function (error) {
      if (ChromeSamples && ChromeSamples.setStatus) {
        console.error(error);
        ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
        error.preventDefault();
      }
    });
  </script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Audiowide">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <h1 class='dpad-focusable' tabindex='0'>Pan Video</h1>
    <div class='profile'>
      <span class='message'>Welcome back, Pan!</span>
      <img src="images/smile.png" alt="" />
    </div>
  </header>

  <section>
    <h2>Recommended</h2>
    <div class='scroll'>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/a_new_hope_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/ad_astra_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/alien_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/apollo_11_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/arrival_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/bladerunner_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/et_thumbnail.jpeg' /></a>
    </div>
  </section>
  <section>
    <h2>Trending</h2>
    <div class='scroll'>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/gravity_thumbnail.png' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/hitchhikers_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/interstellar_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/return_jedi_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/runner_2049_thumbnail.jpeg' /></a>
      <a class='item dpad-focusable' tabindex='0' href='#'><img src='images/spaceballs_thumbnail.jpeg' /></a>
    </div>
  </section>
  <section>
    <h2>Featured</h2>
    <video class="dpad-focusable" tabIndex='0' preload="none" controls></video>
  </section>
  <script>
    var ChromeSamples = {
      log: function () {
        var line = Array.prototype.slice.call(arguments).map(function (argument) {
          return typeof argument === 'string' ? argument : JSON.stringify(argument);
        }).join(' ');

        document.querySelector('#log').textContent += line + '\n';
      },

      clearLog: function () {
        document.querySelector('#log').textContent = '';
      },

      setStatus: function (status) {
        document.querySelector('#status').textContent = status;
      },

      setContent: function (newContent) {
        var content = document.querySelector('#content');
        while (content.hasChildNodes()) {
          content.removeChild(content.lastChild);
        }
        content.appendChild(newContent);
      }
    };
  </script>
  <h3>Live Output</h3>
  <div id="output" class="output">
    <div id="content"></div>
    <div id="status"></div>
    <pre id="log"></pre>
  </div>

  <script>
    if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)) {
      // Let's log a warning if the sample is not supposed to execute on this
      // version of Chrome.
      if (57 > parseInt(RegExp.$1)) {
        ChromeSamples.setStatus('Warning! Keep in mind this sample has been tested with Chrome ' + 57 + '.');
      }
    }
  </script>

  <script>
    if (!('mediaSession' in navigator)) {
      ChromeSamples.setStatus('The Media Session API is not yet available. Try Chrome for Android.');
    }

    // This prevents unnecessary errors when Media Session API is not available.
    navigator.mediaSession = navigator.mediaSession || {};
    navigator.mediaSession.setActionHandler = navigator.mediaSession.setActionHandler || function () { };
    window.MediaMetadata = window.MediaMetadata || function () { };

    log = ChromeSamples.log;
  </script>



  <script>
    let video = document.querySelector('video');

    let playlist = getAwesomePlaylist();
    let index = 0;

    function onPlayButtonClick() {
      playVideo();
    }

    function playVideo() {
      video.src = playlist[index].src;
      video.play()
        .then(_ => updateMetadata())
        .catch(error => log(error.message));
    }

    function updateMetadata() {
      let track = playlist[index];

      log('Playing ' + track.title + ' track...');
      navigator.mediaSession.metadata = new MediaMetadata({
        title: track.title,
        artist: track.artist,
        artwork: track.artwork
      });

      // Media is loaded, set the duration.
      updatePositionState();
    }

    /* Position state (supported since Chrome 81) */

    function updatePositionState() {
      if ('setPositionState' in navigator.mediaSession) {
        log('Updating position state...');
        navigator.mediaSession.setPositionState({
          duration: video.duration,
          playbackRate: video.playbackRate,
          position: video.currentTime
        });
      }
    }

    /* Previous Track & Next Track */

    navigator.mediaSession.setActionHandler('previoustrack', function () {
      log('> User clicked "Previous Track" icon.');
      index = (index - 1 + playlist.length) % playlist.length;
      playVideo();
    });

    navigator.mediaSession.setActionHandler('nexttrack', function () {
      log('> User clicked "Next Track" icon.');
      index = (index + 1) % playlist.length;
      playVideo();
    });

    video.addEventListener('ended', function () {
      // Play automatically the next track when video ends.
      index = (index - 1 + playlist.length) % playlist.length;
      playVideo();
    });

    /* Seek Backward & Seek Forward */

    let defaultSkipTime = 10; /* Time to skip in seconds by default */

    navigator.mediaSession.setActionHandler('seekbackward', function (event) {
      log('> User clicked "Seek Backward" icon.');
      const skipTime = event.seekOffset || defaultSkipTime;
      video.currentTime = Math.max(video.currentTime - skipTime, 0);
      updatePositionState();
    });

    navigator.mediaSession.setActionHandler('seekforward', function (event) {
      log('> User clicked "Seek Forward" icon.');
      const skipTime = event.seekOffset || defaultSkipTime;
      video.currentTime = Math.min(video.currentTime + skipTime, video.duration);
      updatePositionState();
    });

    /* Play & Pause */

    navigator.mediaSession.setActionHandler('play', async function () {
      log('> User clicked "Play" icon.');
      await video.play();
      navigator.mediaSession.playbackState = "playing";
      // Do something more than just playing video...
    });

    navigator.mediaSession.setActionHandler('pause', function () {
      log('> User clicked "Pause" icon.');
      video.pause();
      navigator.mediaSession.playbackState = "paused";
      // Do something more than just pausing video...
    });

    /* Stop (supported since Chrome 77) */

    try {
      navigator.mediaSession.setActionHandler('stop', function () {
        log('> User clicked "Stop" icon.');
        // TODO: Clear UI playback...
      });
    } catch (error) {
      log('Warning! The "stop" media session action is not supported.');
    }

    /* Seek To (supported since Chrome 78) */

    try {
      navigator.mediaSession.setActionHandler('seekto', function (event) {
        log('> User clicked "Seek To" icon.');
        if (event.fastSeek && ('fastSeek' in video)) {
          video.fastSeek(event.seekTime);
          return;
        }
        video.currentTime = event.seekTime;
        updatePositionState();
      });
    } catch (error) {
      log('Warning! The "seekto" media session action is not supported.');
    }

    /* Utils */

    function getAwesomePlaylist() {
      const BASE_URL = 'https://storage.googleapis.com/media-session/';

      return [{
        src: BASE_URL + 'sintel/trailer.mp4',
        title: '"Sintel" Trailer, Durian Open Movie Project',
        artist: 'Blender Foundation',
        artwork: [
          { src: BASE_URL + 'sintel/artwork-96.png', sizes: '96x96', type: 'image/png' },
          { src: BASE_URL + 'sintel/artwork-128.png', sizes: '128x128', type: 'image/png' },
          { src: BASE_URL + 'sintel/artwork-192.png', sizes: '192x192', type: 'image/png' },
          { src: BASE_URL + 'sintel/artwork-256.png', sizes: '256x256', type: 'image/png' },
          { src: BASE_URL + 'sintel/artwork-384.png', sizes: '384x384', type: 'image/png' },
          { src: BASE_URL + 'sintel/artwork-512.png', sizes: '512x512', type: 'image/png' },
        ]
      }, {
        src: BASE_URL + 'big-buck-bunny/trailer.mov',
        title: '"Big Buck Bunny" Trailer, Peach Open Movie Project',
        artist: 'Blender Foundation',
        artwork: [
          { src: BASE_URL + 'big-buck-bunny/artwork-96.png', sizes: '96x96', type: 'image/png' },
          { src: BASE_URL + 'big-buck-bunny/artwork-128.png', sizes: '128x128', type: 'image/png' },
          { src: BASE_URL + 'big-buck-bunny/artwork-192.png', sizes: '192x192', type: 'image/png' },
          { src: BASE_URL + 'big-buck-bunny/artwork-256.png', sizes: '256x256', type: 'image/png' },
          { src: BASE_URL + 'big-buck-bunny/artwork-384.png', sizes: '384x384', type: 'image/png' },
          { src: BASE_URL + 'big-buck-bunny/artwork-512.png', sizes: '512x512', type: 'image/png' },
        ]
      }, {
        src: BASE_URL + 'elephants-dream/teaser.mp4',
        title: '"Elephants Dream" Teaser, Orange Open Movie Project',
        artist: 'Blender Foundation',
        artwork: [
          { src: BASE_URL + 'elephants-dream/artwork-96.png', sizes: '96x96', type: 'image/png' },
          { src: BASE_URL + 'elephants-dream/artwork-128.png', sizes: '128x128', type: 'image/png' },
          { src: BASE_URL + 'elephants-dream/artwork-192.png', sizes: '192x192', type: 'image/png' },
          { src: BASE_URL + 'elephants-dream/artwork-256.png', sizes: '256x256', type: 'image/png' },
          { src: BASE_URL + 'elephants-dream/artwork-384.png', sizes: '384x384', type: 'image/png' },
          { src: BASE_URL + 'elephants-dream/artwork-512.png', sizes: '512x512', type: 'image/png' },
        ]
      }, {
        src: BASE_URL + 'caminandes/short.mp4',
        title: '"Caminandes 2: Gran Dillama" - Blender Animated Short',
        artist: 'Blender Foundation',
        artwork: [
          { src: BASE_URL + 'caminandes/artwork-96.png', sizes: '96x96', type: 'image/png' },
          { src: BASE_URL + 'caminandes/artwork-128.png', sizes: '128x128', type: 'image/png' },
          { src: BASE_URL + 'caminandes/artwork-192.png', sizes: '192x192', type: 'image/png' },
          { src: BASE_URL + 'caminandes/artwork-256.png', sizes: '256x256', type: 'image/png' },
          { src: BASE_URL + 'caminandes/artwork-384.png', sizes: '384x384', type: 'image/png' },
          { src: BASE_URL + 'caminandes/artwork-512.png', sizes: '512x512', type: 'image/png' },
        ]
      }];
    }
  </script>

  <script>
    var playing = false;
    document.querySelector('video').addEventListener('play', onPlayButtonClick, { once: true });
    document.querySelector('video').src = playlist[0].src;
  </script>


</body>

</html>